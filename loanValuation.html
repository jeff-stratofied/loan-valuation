<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Loan Valuation – Model Framework</title>
  <link rel="stylesheet" href="/loan-valuation/shared.css">
</head>
<body>
<section id="valuation-model">

  <main class="valuation-container">

    <header class="valuation-header">
  <h1>Loan Valuation</h1>
  <p class="subtitle">
  Baseline valuation using risk-adjusted discounting (no defaults or prepayments)
</p>
</header>


<section class="valuation-section">
<table class="valuation-table">
<thead>
  <tr>
    <th>Loan</th>
    <th>Principal</th>
    <th>Rate</th>
    <th>Term (yrs)</th>
    <th>Borrower FICO</th>
    <th>Cosigner FICO</th>
    <th>FICO Band</th>
    <th>Risk Tier</th> 
    <th>Discount Rate</th>
    <th>NPV</th>
    <th>NPV / Principal</th> 
    <th>Exp. Loss %</th> 
    <th>WAL (yrs)</th> 
    <th>IRR (%)</th>
  </tr>
</thead>
<tbody id="valuation-body"></tbody>
</table>
</section>


</div>
<div id="valuation-drawer" class="drawer hidden">
  <div class="drawer-header">
    <h2>Loan Valuation</h2>
    <button class="drawer-close" onclick="closeValuationDrawer()">×</button>
  </div>

<div class="drawer-body">

  <section>
    <h3>Loan Inputs</h3>
    <div class="kv-grid" id="val-loan-inputs"></div>
  </section>

  <section>
    <h3>Borrower Profile</h3>
    <div class="kv-grid" id="val-borrower">
      <!-- Populated dynamically: Borrower FICO, Cosigner FICO, Degree Type, School, Year in School, Graduate Student, FICO Band -->
    </div>
  </section>

  <section>
    <h3>Derived Risk Factors</h3>
    <div class="kv-grid" id="val-risk">
      <!-- Populated dynamically: Risk Tier (colored), Base Risk (bps), Degree Adj, School Adj, Year Adj, Grad Adj, Total Risk (bps) -->
    </div>
  </section>

  <section>
    <h3>Discount Rate Breakdown</h3>
    <table class="mini-table" id="val-discount-table"></table>
  </section>

  <section>
    <h3>Valuation Summary</h3>
    <div class="kv-grid" id="val-summary"></div>
  </section>
  
</div>


<script type="module">
import { loadLoans } from "./loadLoans.js?v=dev";
  
import { loadBorrowers, getBorrowerById, BORROWERS } from "./borrowerStore.js?v=dev";

import { getEffectiveBorrower, setOverride, VALUATION_OVERRIDES, loadOverrides } from "./valuationOverrides.js?v=dev";

  import { valueLoan, loadValuationCurves, VALUATION_CURVES, deriveFicoBand, loadSchoolTiers, SCHOOLTIERS, getSchoolName } from "/loan-valuation/valuationEngine.js?v=dev";

let loans = [];

const RISK_FREE_RATE = 0.0423; // 4.23% — US 10Y Treasury yield on Feb 02, 2026 (avg from Trading Economics/FRED/Treasury.gov)
  
window.closeValuationDrawer = function () {
  const drawer = document.getElementById("valuation-drawer");
  if (!drawer) return;
  drawer.classList.add("hidden");
};

  function getSystemBorrower(loan) {
return getBorrowerById(loan.borrowerId) || {}; // Fallback to empty if not found
}

function openValuationDrawer({ loan, borrower, valuation }, clickedRow = null) {
  const drawer = document.getElementById("valuation-drawer");
  if (!drawer) {
    console.warn("Valuation drawer element not found – skipping open");
    return;
  }

  // Clear any existing active row highlights
  document.querySelectorAll('.valuation-table tbody tr.active')
    .forEach(tr => tr.classList.remove('active'));

  // Highlight the clicked row if provided
  if (clickedRow) {
    clickedRow.classList.add('active');
  }

  // Display the drawer
  drawer.classList.remove("hidden");

  // Attach loan data to drawer for internal use
  drawer._loan = loan;

  // Retrieve the authoritative borrower record
  const systemBorrower = getBorrowerById(loan.borrowerId) ?? {};

  // Store a clean copy of system values for display consistency / reset logic if needed later
  drawer._systemBorrower = {
  borrowerFico:        systemBorrower.borrowerFico        ?? null,
  cosignerFico:        systemBorrower.cosignerFico        ?? null,
  degreeType:          systemBorrower.degreeType          ?? "Other",
  school:              systemBorrower.school              ?? "Unknown",
  yearInSchool:        systemBorrower.yearInSchool        ?? 1,
  isGraduateStudent:   systemBorrower.isGraduateStudent   ?? false,
  opeid:               systemBorrower.opeid               ?? ""  // ADD THIS
};

  // Use the already-provided effective borrower (system + any existing overrides)
  // This is the value that was used to calculate the valuation passed in
  drawer._borrower = borrower;

  // Render the read-only details using the effective borrower data
  renderValuationDetails(loan, drawer._borrower, valuation);
}

  
async function init() {
  loadOverrides(); // Existing - sync, localStorage

  const BACKEND_URL = "https://loan-valuation-api.jeff-263.workers.dev";

  // 1. Load loans (backend primary, GitHub fallback)
  let loanData;
  try {
    const res = await fetch(`${BACKEND_URL}/loans`, { cache: "no-store" });
    if (!res.ok) throw new Error(`Loans fetch failed: ${res.status}`);
    loanData = await res.json();
  } catch (err) {
    console.warn("Backend loans failed:", err);
    loanData = await loadLoans(); // Fallback to existing GitHub loader
  }
  loans = loanData.loans || [];

  // 2. Load borrowers (backend primary, GitHub fallback)
  try {
    const res = await fetch(`${BACKEND_URL}/borrowers`, { cache: "no-store" });
    if (res.ok) {
      const data = await res.json();
      BORROWERS.length = 0;
      BORROWERS.push(...(data.borrowers || data || []));
    } else {
      throw new Error(`Borrowers fetch failed: ${res.status}`);
    }
  } catch (err) {
    console.warn("Backend borrowers failed, falling back to GitHub:", err);
    const fallbackRes = await fetch(
      "https://raw.githubusercontent.com/jeff-stratofied/loan-valuation/main/data/borrowers.json",
      { cache: "no-store" }
    );
    const data = await fallbackRes.json();
    BORROWERS.length = 0;
    BORROWERS.push(...(data.borrowers || data || []));
  }

  // 3. Load valuation curves (using exported function, backend primary)
  try {
    await loadValuationCurves(`${BACKEND_URL}/valuationCurves`, { cache: "no-store" });
  } catch (err) {
    console.warn("Backend valuation curves failed, falling back to GitHub:", err);
    await loadValuationCurves(
      "https://raw.githubusercontent.com/jeff-stratofied/loan-valuation/main/data/valuationCurves.json",
      { cache: "no-store" }
    );
  }

  // 4. Load school tiers (using exported function, backend primary)
  try {
    await loadSchoolTiers(`${BACKEND_URL}/schoolTiers`, { cache: "no-store" });
  } catch (err) {
    console.warn("Backend school tiers failed, falling back to GitHub:", err);
    await loadSchoolTiers(
      "https://raw.githubusercontent.com/jeff-stratofied/loan-valuation/main/data/schoolTiers.json",
      { cache: "no-store" }
    );
  }

// Add this after your table is rendered (e.g., end of init() or window.onload)
const drawerCloseBtn = document.querySelector('.drawer-close');
if (drawerCloseBtn) {
  drawerCloseBtn.addEventListener('click', () => {
    document.querySelectorAll('.valuation-table tr.active').forEach(row => {
      row.classList.remove('active');
    });
    // Optional: close drawer if not already
    document.querySelector('.drawer').classList.add('hidden');
  });
}

  
  // All data loaded → render
  renderValuations();
}

  
function renderValuations() {
  if (!VALUATION_CURVES) return; // Guard

  const tbody = document.querySelector('.valuation-table tbody');
  tbody.innerHTML = '';

  let totalPrincipal = 0;
  let totalNPV = 0;
  let totalExpectedLoss = 0;
  let weightedWAL = 0;

  loans.forEach((loan) => {
    const systemBorrower = getBorrowerById(loan.borrowerId) || {}; // Use from borrowerStore.js
    const effectiveBorrower = getEffectiveBorrower({ loan, systemBorrower });
    const valuation = valueLoan({ loan, borrower: effectiveBorrower, riskFreeRate: RISK_FREE_RATE });
    const principal = Number(loan.principal);
    const row = document.createElement('tr');

    totalPrincipal += principal;
    totalNPV += valuation.npv;
    totalExpectedLoss += valuation.expectedLoss * principal;
    weightedWAL += valuation.wal * principal;

row.innerHTML = `
    <td>${loan.loanName || loan.loanId}</td>
    <td>$${principal.toLocaleString()}</td>
    <td>${(loan.rate * 100).toFixed(2)}%</td>
    <td>${loan.termYears}</td>
    <td>${effectiveBorrower.borrowerFico || '—'}</td>
    <td>${effectiveBorrower.cosignerFico || '—'}</td>
    <td>${deriveFicoBand(Math.max(effectiveBorrower.borrowerFico || 0, effectiveBorrower.cosignerFico || 0))}</td>
    <td>${valuation.riskTier}</td>
    <td>${(valuation.discountRate * 100).toFixed(2)}%</td>
    <td>$${Math.round(valuation.npv).toLocaleString()}</td>
    <td>${(valuation.npvRatio * 100).toFixed(1)}%</td>
    <td>${(valuation.expectedLoss * 100).toFixed(2)}%</td>
    <td>${valuation.wal.toFixed(1)}</td>
    <td class="${getIRRColorClass(valuation.irr)}">
      ${Number.isFinite(valuation.irr) ? valuation.irr.toFixed(2) : '—'}%
    </td>
  `;

  // Use effectiveBorrower here — it's already in scope from earlier in the loop
  row.onclick = () => openValuationDrawer(
    { loan, borrower: effectiveBorrower, valuation },
    row
  );

const irrValue = valuation.irr;
console.log(`Loan: ${loan.loanName}, IRR: ${irrValue}, Type: ${typeof irrValue}`); // Check value

const irrCell = document.createElement('td');
irrCell.textContent = isNaN(irrValue) ? 'N/A' : irrValue.toFixed(2) + '%';

if (isNaN(irrValue)) {
  irrCell.classList.add('text-muted'); // Gray for errors
  console.log(`NaN IRR for ${loan.loanName} - added text-muted`);
} else if (irrValue < 0) {
  irrCell.classList.add('text-yellow-600'); // Red/orange
  console.log(`Negative IRR for ${loan.loanName} - added text-yellow-600`);
} else {
  irrCell.classList.add('text-green-600'); // Green
  console.log(`Positive IRR for ${loan.loanName} - added text-green-600`);
}
    
  tbody.appendChild(row);
  });

  // Portfolio summary
  const summaryRow = document.createElement('tr');
  summaryRow.className = 'summary-row';
  summaryRow.innerHTML = `
    <td><strong>Portfolio Total</strong></td>
    <td>$${totalPrincipal.toLocaleString()}</td>
    <td colspan="5"></td>
    <td></td>
    <td></td>
    <td>$${Math.round(totalNPV).toLocaleString()}</td>
    <td>${((totalNPV / totalPrincipal - 1) * 100).toFixed(1)}%</td>
    <td>${((totalExpectedLoss / totalPrincipal) * 100).toFixed(2)}%</td>
    <td>${(weightedWAL / totalPrincipal).toFixed(1)}</td>
  `;
  tbody.appendChild(summaryRow);
}


function renderValuationDetails(loan, borrower, valuation) {
  // 1. Loan Inputs (unchanged)
  document.getElementById("val-loan-inputs").innerHTML = `
    <div>Principal: $${Number(loan.principal).toLocaleString()}</div>
    <div>Rate: ${(loan.rate * 100).toFixed(2)}%</div>
    <div>Term: ${loan.termYears} years</div>
  `;

  // 2. Borrower Profile (expanded for full context, read-only)
  const effectiveFico = Math.max(borrower.borrowerFico || 0, borrower.cosignerFico || 0);
  document.getElementById("val-borrower").innerHTML = `
    <div>Borrower FICO: ${borrower.borrowerFico || "—"}</div>
    <div>Cosigner FICO: ${borrower.cosignerFico || "—"}</div>
    <div>Degree Type: ${borrower.degreeType || "Other"}</div>
    <div>School: ${getSchoolName(borrower.school, borrower.opeid)}</div>
    <div>Year in School: ${borrower.yearInSchool || "—"}</div>
    <div>Graduate Student: ${borrower.isGraduateStudent ? "Yes" : "No"}</div>
    <div>FICO Band: ${deriveFicoBand(effectiveFico)}</div>
  `;

  // 3. Derived Risk Factors (unchanged, but ensures all adjustments are visible)
  const tierColorMap = { /* unchanged */ };
  const color = tierColorMap[valuation.riskTier] || "gray";
  document.getElementById("val-risk").innerHTML = `
    <div>Risk Tier: <span class="text-${color}-600 font-bold">${valuation.riskTier}</span></div>
    <div>Base Risk (bps): ${valuation.riskBreakdown?.baseRiskBps ?? "—"}</div>
    <div>Degree Adj: ${valuation.riskBreakdown?.degreeAdj ?? "—"}</div>
    <div>School Adj: ${valuation.riskBreakdown?.schoolAdj ?? "—"}</div>
    <div>Year Adj: ${valuation.riskBreakdown?.yearAdj ?? "—"}</div>
    <div>Grad Adj: ${valuation.riskBreakdown?.gradAdj ?? "—"}</div>
    <div>Total Risk (bps): ${valuation.riskBreakdown?.totalRiskBps ?? "—"}</div>
  `;

  // 4. Discount Rate Breakdown (unchanged)
  document.getElementById("val-discount-table").innerHTML = `
    <tr><td>Risk-Free Rate</td><td>${(RISK_FREE_RATE * 100).toFixed(2)}%</td></tr>
    <tr><td>Risk Premium</td><td>${((valuation.discountRate - RISK_FREE_RATE) * 100).toFixed(2)}%</td></tr>
    <tr><td>Total Discount Rate</td><td class="font-bold">${(valuation.discountRate * 100).toFixed(2)}%</td></tr>
  `;

// 5. Valuation Summary (updated with IRR)
const npvRatio = loan.principal > 0 ? (valuation.npv / loan.principal) - 1 : null;
document.getElementById("val-summary").innerHTML = `
  <div>NPV: <span class="font-bold">$${Math.round(valuation.npv).toLocaleString()}</span></div>
  <div>NPV / Principal: ${npvRatio == null ? "—" : `${(npvRatio * 100).toFixed(1)}%`}</div>
  <div>IRR: <span class="font-bold" title="Internal Rate of Return – annualized yield considering timing of all expected cash flows">
    ${valuation.irr && Number.isFinite(valuation.irr) ? valuation.irr.toFixed(2) + '%' : '—'}
  </span></div>
  <div>Expected Loss %: ${(valuation.expectedLoss * 100).toFixed(2)}%</div>
  <div>WAL (yrs): ${valuation.wal.toFixed(1)}</div>
`;

// Curves section (minor cleanup only – no functional change needed)
const curvesSection = `
  <section>
    <h3 style="cursor:pointer; user-select:none;"
        onclick="this.nextElementSibling.classList.toggle('hidden')">
      Underlying Valuation Curves
      <span style="font-size:0.75rem; opacity:0.7; margin-left:8px;">click to expand</span>
    </h3>

    <div class="hidden" style="margin-top:12px; font-size:13px; line-height:1.45;">
      <div style="margin-bottom:16px; color:#475569;">
        <strong>Selected curves for:</strong> ${valuation.riskTier} tier
        (borrower FICO ${borrower.borrowerFico || '—'}, cosigner ${borrower.cosignerFico || '—'})
      </div>

      <table class="mini-table" style="width:100%; margin-bottom:16px;">
        <thead>
          <tr><th>Curve</th><th>Values</th><th>Notes</th></tr>
        </thead>
        <tbody>
          <tr>
            <td>Base risk premium</td>
            <td>${valuation.curve?.riskPremiumBps?.toLocaleString() ?? '—'} bps</td>
            <td>before degree/school/year adjustments</td>
          </tr>
          <tr>
            <td>Cumulative default % (end of years 1–10)</td>
            <td>${valuation.curve?.defaultCurve?.cumulativeDefaultPct?.map(v => v.toFixed(2)).join(' → ') ?? '—'}%</td>
            <td>interpolated to monthly PD</td>
          </tr>
          <tr>
            <td>Annual prepayment (CPR %)</td>
            <td>${valuation.curve?.prepaymentCurve?.valuesPct?.join(' → ') ?? '—'}%</td>
            <td>years 1–10; converted to monthly SMM</td>
          </tr>
          <tr>
            <td>Recovery rate & timing</td>
            <td>${valuation.curve?.recovery?.grossRecoveryPct ?? '—'}% after ${valuation.curve?.recovery?.recoveryLagMonths ?? '—'} months</td>
            <td>applied to default amounts</td>
          </tr>
        </tbody>
      </table>

      <div style="font-size:11px; color:#64748b;">
        These are the deterministic base assumptions for the ${valuation.riskTier} risk tier.<br>
        Degree, school tier, and year-in-school adjustments are applied only to the discount rate (additive bps).
      </div>

      <!-- Button remains as-is (assuming you already have event listener) -->
      <button id="view-curves-btn" 
              style="margin-top:12px; font-size:13px; padding:6px 12px; border:1px solid #cbd5e1; 
                     border-radius:6px; background:#f8fafc; cursor:pointer;">
        View curves graphically →
      </button>
    </div>
  </section>
`;

  // Insert the entire curves section into the drawer (e.g., after #val-summary)
  const drawerBody = document.querySelector('.drawer-body');
  let curvesElem = document.getElementById('curves-section');  // Add id="curves-section" to the <section> if needed
  if (!curvesElem) {
    curvesElem = document.createElement('div');
    curvesElem.id = 'curves-section';
    drawerBody.appendChild(curvesElem);
  }
  curvesElem.innerHTML = curvesSection;

  const btn = document.getElementById('view-curves-btn');
if (btn) {
  btn.onclick = () => {
    showCurvesModal(valuation.riskTier, valuation.curve);  // Pass objects directly – no JSON needed
  };
}
}


function rerunValuation(drawer) {
  const systemBorrower = drawer._systemBorrower;

  const borrower = getEffectiveBorrower({
    loan: drawer._loan,
    systemBorrower
  });

  const valuation = valueLoan({
    loan: drawer._loan,
    borrower,
    riskFreeRate: RISK_FREE_RATE
  });

  renderValuationDetails(
    drawer._loan,
    borrower,
    valuation
  );

  // Keep drawer state in sync
  drawer._borrower = borrower;

  // Manually trigger table row re-render to reflect the "Edited" badge
  renderValuations();
}



window.resetValuationOverride = function () {
  const drawer = document.getElementById("valuation-drawer");
  const loanId = drawer._loan.loanId;

  // Remove override from the in-memory map
  VALUATION_OVERRIDES.delete(loanId);

  // Remove override from localStorage
  const overrides = Object.fromEntries(VALUATION_OVERRIDES.entries());
  localStorage.setItem("loanValuationOverrides", JSON.stringify(overrides));

  // Get the system borrower data (i.e., before any overrides)
  const systemBorrower = drawer._systemBorrower;

  // Manually reset form fields with system borrower values
  const ficoSelect = document.getElementById("val-borrower-fico");
  ficoSelect.value = systemBorrower.borrowerFico ?? "";

  const degreeSelect = document.getElementById("val-degree-type");
  degreeSelect.value = systemBorrower.degreeType ?? "Other";

  // Prepare the borrower data for recalculation - COMPLETE WITH ALL FIELDS
  const borrower = {
  borrowerFico: ficoSelect.value ? Number(ficoSelect.value) : systemBorrower.borrowerFico,
  degreeType: degreeSelect.value || systemBorrower.degreeType,
  cosignerFico: systemBorrower.cosignerFico ?? null,
  school: systemBorrower.school ?? "Unknown",
  yearInSchool: systemBorrower.yearInSchool ?? 1,
  isGraduateStudent: systemBorrower.isGraduateStudent ?? false,
  opeid: systemBorrower.opeid ?? ""  // ADD THIS
};

  // Re-run valuation for the updated loan (to reflect the reset)
  const valuation = valueLoan({
    loan: drawer._loan,
    borrower,
    riskFreeRate: RISK_FREE_RATE
  });

  // Recalculate the discount rate and NPV with updated values
  renderValuationDetails(drawer._loan, borrower, valuation);

  // Refresh the table to reflect the changes (no overrides)
  renderValuations();

  // Re-populate the drawer inputs with system values immediately, passing the recalculated valuation
  // OPTIONAL: Comment out or remove this if you want to avoid redundancy (drawer is already updated and open)
  openValuationDrawer({
    loan: drawer._loan,
    borrower: systemBorrower,
    valuation: valuation // Pass the recalculated valuation object here
  });
};

function getIRRColorClass(irr) {
  if (!Number.isFinite(irr)) return '';
  if (irr >= 12) return 'text-green-600 font-bold';     // strong return
  if (irr >= 9)  return 'text-green-600';               // good
  if (irr >= 6)  return 'text-yellow-600';              // moderate
  if (irr >= 3)  return 'text-orange-600';              // low / concerning
  return 'text-red-600';                                // very low / loss territory
}

  
function showCurvesModal(riskTier, curve) {
  const modal = document.getElementById('curveModal');
  if (!modal) return;

  // Update title safely
  document.getElementById('modalTitle').textContent = `Valuation Curves – ${riskTier || 'Unknown Tier'}`;

  // Clean up any existing charts
  destroyChart(window.defaultChart);
  destroyChart(window.cprChart);

  // Debug output
  console.log('[Curves Modal] Risk Tier:', riskTier);
  console.log('[Curves Modal] Curve object:', curve);

  // Extract data with safe fallbacks
  const defaultData = curve?.defaultCurve?.cumulativeDefaultPct ?? [];
  const prepayData = curve?.prepaymentCurve?.valuesPct ?? [];

  // Show modal first (ensures DOM is visible for proper sizing)
  modal.classList.remove('hidden');

  // Defer chart creation to next tick (fixes sizing/reflow issues)
  setTimeout(() => {
    renderDefaultChart(defaultData);
    renderPrepayChart(prepayData);
  }, 0);
}

// Helper: safely destroy a chart instance
function destroyChart(chartInstance) {
  if (chartInstance && typeof chartInstance.destroy === 'function') {
    chartInstance.destroy();
  }
}

// Helper: render cumulative default chart
function renderDefaultChart(data) {
  const canvas = document.getElementById('defaultChart');
  if (!canvas) return;

  if (data.length === 0) {
    canvas.parentNode.innerHTML += 
      '<p style="text-align:center; color:#999; font-size:12px; margin-top:20px;">No default curve data available</p>';
    return;
  }

  window.defaultChart = new Chart(canvas, {
    type: 'line',
    data: {
      labels: Array.from({ length: data.length }, (_, i) => `Year ${i + 1}`),
      datasets: [{
        label: 'Cumulative Default %',
        data: data,
        borderColor: '#dc2626',
        backgroundColor: 'rgba(220, 38, 38, 0.1)',
        fill: true,
        tension: 0,
        stepped: 'after'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: '%' }
        }
      }
    }
  });
}

// Helper: render annual prepayment (CPR) chart
function renderPrepayChart(data) {
  const canvas = document.getElementById('cprChart');
  if (!canvas) return;

  if (data.length === 0) {
    canvas.parentNode.innerHTML += 
      '<p style="text-align:center; color:#999; font-size:12px; margin-top:20px;">No prepayment data available</p>';
    return;
  }

  window.cprChart = new Chart(canvas, {
    type: 'bar',
    data: {
      labels: Array.from({ length: data.length }, (_, i) => `Year ${i + 1}`),
      datasets: [{
        label: 'Annual CPR %',
        data: data,
        backgroundColor: '#3b82f6'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: '%' }
        }
      }
    }
  });
}
  

init();
</script>
</section>

<!-- Add once at bottom of loanValuation.html body -->
<div id="curveModal" class="modal hidden">
  <div class="modal-content">
    <button class="modal-close" onclick="document.getElementById('curveModal').classList.add('hidden')">×</button>
    <h3 id="modalTitle" class="modal-title">Valuation Curves</h3>
    <div class="modal-grid">
      <div class="chart-section">
        <h4 class="chart-subtitle">Cumulative Default Curve</h4>
        <div class="chart-wrapper">
          <canvas id="defaultChart"></canvas>
        </div>
      </div>
      <div class="chart-section">
        <h4 class="chart-subtitle">Annual Prepayment (CPR)</h4>
        <div class="chart-wrapper">
          <canvas id="cprChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>
  

  
<!-- Chart.js CDN – add this if not already present -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  
</body>
</html>
