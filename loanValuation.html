<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Loan Valuation – Model Framework</title>

<style>
  /* ===== Loan Valuation Page ===== */

  .valuation-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
  }

  .valuation-header h1 {
    margin-bottom: 4px;
  }

  .subtitle {
    color: #666;
    font-size: 0.95rem;
  }

  .valuation-section {
    margin-top: 32px;
  }

  .valuation-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 16px;
  }

  .valuation-table th,
  .valuation-table td {
    padding: 10px 12px;
    border-bottom: 1px solid #ddd;
    text-align: right;
    font-size: 0.9rem;
  }

  .valuation-table th {
    background: #f7f7f7;
    font-weight: 600;
  }

  .valuation-table th:first-child,
  .valuation-table td:first-child {
    text-align: left;
  }

  .valuation-divider {
    margin: 48px 0;
    opacity: 0.3;
  }

  .drawer {
  position: fixed;
  top: 0;
  right: 0;
  width: 420px;
  height: 100%;
  background: #fff;
  border-left: 1px solid #ddd;
  box-shadow: -4px 0 12px rgba(0,0,0,0.08);
  z-index: 1000;
  overflow-y: auto;
}

.drawer.hidden {
  display: none;
}

.drawer-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  border-bottom: 1px solid #eee;
}

.drawer-body {
  padding: 16px;
}

.drawer h3 {
  margin-top: 20px;
  font-size: 14px;
  text-transform: uppercase;
  color: #555;
}

.kv-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 8px 12px;
  font-size: 13px;
}

.kv-grid div {
  padding: 2px 0;
}

.mini-table {
  width: 100%;
  font-size: 13px;
  border-collapse: collapse;
}

.mini-table td {
  padding: 4px 0;
}

.drawer-close {
  font-size: 20px;
  background: none;
  border: none;
  cursor: pointer;
}

.override-badge {
  margin-left: 6px;
  font-size: 11px;
  color: #b45309;
  background: #fef3c7;
  padding: 2px 6px;
  border-radius: 999px;
}

  .summary-row {
  font-weight: 600;
  border-top: 2px solid #ddd;
}

.valuation-table td, .valuation-table th {
  text-align: right;
}

.valuation-table td:first-child, .valuation-table th:first-child {
  text-align: left;
}

.text-green-600 { color: #16a34a; }
.text-yellow-600 { color: #ca8a04; }
.text-orange-600 { color: #c2410c; }
.text-red-600   { color: #dc2626; }
.font-bold { font-weight: 700; }

.grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
.mini-table td { border: 1px solid #ddd; padding: 8px; }
  
</style>

  
</head>
<body>
<section id="valuation-model">

  <main class="valuation-container">

    <header class="valuation-header">
  <h1>Loan Valuation</h1>
  <p class="subtitle">
  Baseline valuation using risk-adjusted discounting (no defaults or prepayments)
</p>
</header>


    <!-- ========================= -->
    <!-- 1. MODEL OVERVIEW         -->
    <!-- ========================= -->
    <section class="valuation-section">
      <h2>1. Model Overview</h2>
      <p>
        This valuation model estimates the fair value of individual private student loans
        by projecting expected cash flows over the life of each loan and discounting those
        cash flows using a risk-adjusted discount rate.
      </p>
      <p>
        Risk is evaluated at the loan level and can be aggregated into cohorts and
        portfolios. All assumptions are explicit, modular, and adjustable.
      </p>
    </section>

    <!-- ========================= -->
    <!-- 2. BORROWER INPUTS        -->
    <!-- ========================= -->
    <section class="valuation-section">
      <h2>2. Borrower & Education Inputs</h2>

      <h3>Locked Identifiers</h3>
      <ul>
        <li><strong>Borrower ID</strong> – Unique identifier, not editable</li>
        <li><strong>Borrower Name</strong> – Descriptive label only</li>
        <li><strong>School</strong> – Used for cohort analysis</li>
      </ul>

      <h3>Editable Risk Inputs</h3>
      <ul>
        <li><strong>Borrower FICO</strong> – Required (nullable)</li>
        <li><strong>Cosigner FICO</strong> – Optional</li>
        <li><strong>Year in School</strong> – 1–4 or 4+ (extended programs)</li>
        <li><strong>Graduate Student</strong> – Yes / No</li>
        <li><strong>Degree Type</strong> – STEM, Business, Liberal Arts, Professional, Other</li>
      </ul>
    </section>

    <!-- ========================= -->
    <!-- 3. DERIVED RISK LAYERS    -->
    <!-- ========================= -->
    <section class="valuation-section">
      <h2>3. Derived Risk Layers</h2>

      <h3>3.1 FICO Banding</h3>
      <p>
        Raw FICO scores are mapped to industry-standard FICO bands used in private
        student loan and ABS markets.
      </p>
      <table>
        <thead>
          <tr><th>Band</th><th>FICO Range</th></tr>
        </thead>
        <tbody>
          <tr><td>A</td><td>760+</td></tr>
          <tr><td>B</td><td>720–759</td></tr>
          <tr><td>C</td><td>680–719</td></tr>
          <tr><td>D</td><td>640–679</td></tr>
          <tr><td>E</td><td>&lt;640</td></tr>
          <tr><td>Unknown</td><td>No FICO Provided</td></tr>
        </tbody>
      </table>

      <h3>3.2 School Tier</h3>
      <p>
        Schools are categorized into tiers based on completion rates and post-graduation
        earnings outcomes using publicly available education data.
      </p>
      <ul>
        <li><strong>Tier 1</strong> – High completion, strong earnings</li>
        <li><strong>Tier 2</strong> – Average outcomes</li>
        <li><strong>Tier 3</strong> – Lower completion and/or earnings</li>
      </ul>

      <h3>3.3 Program Risk Factors</h3>
      <ul>
        <li>Degree type (e.g. STEM vs Liberal Arts)</li>
        <li>Graduate vs undergraduate</li>
        <li>Progress toward completion (year in school)</li>
      </ul>

      <h3>3.4 Risk Tier</h3>
      <p>
        Borrower credit, educational progress, degree type, and school tier are combined
        to assign each loan to a consolidated risk tier.
      </p>
      <ul>
        <li>Low Risk</li>
        <li>Medium Risk</li>
        <li>High Risk</li>
        <li>Very High Risk</li>
      </ul>
    </section>

    <!-- ========================= -->
    <!-- 4. CASH FLOW ASSUMPTIONS  -->
    <!-- ========================= -->
    <section class="valuation-section">
      <h2>4. Cash Flow Assumptions</h2>

      <h3>Default Rate</h3>
      <p>
        Expected defaults are modeled using cumulative default curves over the repayment
        term, selected based on the loan’s risk tier.
      </p>

      <h3>Recovery Rate</h3>
      <p>
        Recovery assumptions reflect expected collections post-default and vary based on
        cosigner presence and credit quality.
      </p>

      <h3>Loss / Charge-Off Rate</h3>
      <p>
        Loss is derived as:
      </p>
      <pre>Loss = Default Rate × (1 − Recovery Rate)</pre>

      <h3>Prepayment Rate</h3>
      <p>
        Prepayments are modeled using prepayment curves influenced by borrower credit
        quality, income prospects, and interest rate environment.
      </p>
    </section>

    <!-- ========================= -->
    <!-- 5. DISCOUNTING            -->
    <!-- ========================= -->
    <section class="valuation-section">
      <h2>5. Discount Rate & NPV</h2>

      <h3>Risk-Free Rate</h3>
      <p>
        The risk-free rate is based on the current U.S. 10-Year Treasury yield.
      </p>

      <h3>Risk Premium</h3>
      <p>
        A risk premium is added to compensate for borrower risk, uncertainty, and
        illiquidity. This premium varies by risk tier.
      </p>

      <h3>Discount Rate</h3>
      <pre>Discount Rate = Risk-Free Rate + Risk Premium</pre>

      <h3>Net Present Value (NPV)</h3>
      <p>
        Projected net cash flows are discounted using the risk-adjusted discount rate to
        calculate the loan’s net present value.
      </p>
    </section>

    <!-- ========================= -->
    <!-- 6. PORTFOLIO AGGREGATION  -->
    <!-- ========================= -->
    <section class="valuation-section">
      <h2>6. Cohort & Portfolio Valuation</h2>
      <p>
        Individual loan valuations can be aggregated into cohorts based on shared
        attributes such as school, FICO band, year in school, or degree type.
      </p>
      <p>
        Portfolio-level metrics include weighted average risk, expected loss, and total
        portfolio NPV.
      </p>
    </section>

    <!-- ========================= -->
    <!-- 7. TRANSPARENCY           -->
    <!-- ========================= -->
    <section class="valuation-section">
      <h2>7. Transparency & Adjustability</h2>
      <p>
        All model assumptions, curves, and premiums are explicit and adjustable. Users can
        stress-test valuations by modifying individual risk levers while preserving a
        documented base case.
      </p>
    </section>
  </main>

</section>

  <section id="valuation-controls">
  <h2>Scenario Controls</h2>
  <!-- empty for now -->
</section>

  <hr class="valuation-divider" />

  <section id="valuation-results">
<div class="valuation-container">


<header class="valuation-header">
<h1>Loan Valuation (v0)</h1>
<p class="subtitle">Read-only baseline valuation using risk-adjusted discounting</p>
</header>


<section class="valuation-section">
<table class="valuation-table">
<thead>
  <tr>
    <th>Loan</th>
    <th>Principal</th>
    <th>Rate</th>
    <th>Term (yrs)</th>
    <th>Borrower FICO</th>
    <th>Cosigner FICO</th>
    <th>FICO Band</th>
    <th>Risk Tier</th> <!-- NEW -->
    <th>Discount Rate</th>
    <th>NPV</th>
    <th>NPV / Principal</th> <!-- NEW as % -->
    <th>Exp. Loss %</th> <!-- NEW -->
    <th>WAL (yrs)</th> <!-- NEW -->
  </tr>
</thead>
<tbody id="valuation-body"></tbody>
</table>
</section>


</div>
<div id="valuation-drawer" class="drawer hidden">
  <div class="drawer-header">
    <h2>Loan Valuation</h2>
    <button class="drawer-close" onclick="closeValuationDrawer()">×</button>
  </div>

  <div class="drawer-body">

    <section>
      <h3>Loan Inputs</h3>
      <div class="kv-grid" id="val-loan-inputs"></div>
    </section>

   <section>
  <h3>Borrower Profile</h3>

     <button
  class="reset-btn"
  onclick="resetValuationOverride()"
>
  Reset to system ratings
</button>


  <!-- Editable controls -->
  <div class="kv-grid">
    <label>Borrower FICO</label>
    <select id="val-borrower-fico">
      <option value="">FICO not provided</option>
      <option value="720">720+</option>
      <option value="690">690–719</option>
      <option value="660">660–689</option>
      <option value="620">620–659</option>
      <option value="580">580–619</option>
      <option value="540">&lt;580</option>
    </select>

    <label>Degree Type</label>
    <select id="val-degree-type">
      <option value="STEM">STEM</option>
      <option value="Business">Business</option>
      <option value="Professional">Professional (e.g. Nursing)</option>
      <option value="Other">Other</option>
    </select>
  </div>

  <!-- Derived borrower display -->
  <div class="kv-grid" id="val-borrower"></div>
</section>



    <section>
      <h3>Derived Risk</h3>
      <div class="kv-grid" id="val-risk"></div>
    </section>

    <section>
      <h3>Discount Rate Breakdown</h3>
      <table class="mini-table" id="val-discount-table"></table>
    </section>

    <section>
      <h3>Valuation Summary</h3>
      <div class="kv-grid" id="val-summary"></div>
    </section>
  </div>


<script type="module">
import { loadLoans } from "./loadLoans.js?v=dev";
  
import { loadBorrowers, getBorrowerById, BORROWERS } from "./borrowerStore.js?v=dev";
  
import { valueLoan, loadValuationCurves, VALUATION_CURVES, deriveFicoBand } from "/loan-valuation/valuationEngine.js?v=dev";

import { getEffectiveBorrower, setOverride, VALUATION_OVERRIDES, loadOverrides } from "./valuationOverrides.js?v=dev";

let loans = [];

const RISK_FREE_RATE = 0.0423; // 4.23% — US 10Y Treasury yield on Feb 02, 2026 (avg from Trading Economics/FRED/Treasury.gov)
  
window.closeValuationDrawer = function () {
  const drawer = document.getElementById("valuation-drawer");
  if (!drawer) return;
  drawer.classList.add("hidden");
};

  function getSystemBorrower(loan) {
return getBorrowerById(loan.borrowerId) || {}; // Fallback to empty if not found
}

function openValuationDrawer({ loan, borrower, valuation }) {
  const drawer = document.getElementById("valuation-drawer");
  drawer.classList.remove("hidden");

  // Cache loan
  drawer._loan = loan;

  // ---- System-of-record borrower (immutable baseline) - FETCH FRESH FROM STORE
  const systemBorrower = getBorrowerById(loan.borrowerId) || {};
  drawer._systemBorrower = {
    borrowerFico: systemBorrower.borrowerFico ?? null,
    cosignerFico: systemBorrower.cosignerFico ?? null,
    degreeType: systemBorrower.degreeType ?? "Other",
    school: systemBorrower.school ?? "Unknown",
    yearInSchool: systemBorrower.yearInSchool ?? 1,
    isGraduateStudent: systemBorrower.isGraduateStudent ?? false
  };

  // ---- Apply any existing overrides
  const override = VALUATION_OVERRIDES.get(loan.loanId) ?? {};

  drawer._borrower = getEffectiveBorrower({
    loan,
    systemBorrower: drawer._systemBorrower
  });

  // -----------------------------
  // Reset and populate editable fields (always from _systemBorrower)
  // -----------------------------
  // NOTE: The code below actually sets from drawer._borrower (effective) - this is correct, keep it.
  const ficoSelect = document.getElementById("val-borrower-fico");
  ficoSelect.value = drawer._borrower.borrowerFico ?? "";

  const degreeSelect = document.getElementById("val-degree-type");
  degreeSelect.value = drawer._borrower.degreeType ?? "Other";

  // -----------------------------
  // ial render (effective borrower)
  // -----------------------------
  renderValuationDetails(
    loan,
    drawer._borrower,
    valuation
  );

  // -----------------------------
  // Live revaluation handlers
  // -----------------------------
  ficoSelect.onchange = () => {
    setOverride(loan.loanId, {
      borrowerFico: ficoSelect.value ? Number(ficoSelect.value) : null
    });
    rerunValuation(drawer);
  };

  degreeSelect.onchange = () => {
    setOverride(loan.loanId, {
      degreeType: degreeSelect.value
    });
    rerunValuation(drawer);
  };
}

  
async function init() {
  loadOverrides();  // Existing

  const BACKEND_URL = "https://loan-valuation-api.jeff-263.workers.dev";  // Match admin

  // Load loans (backend first, fallback to loadLoans which uses GitHub)
  let loanData;
  try {
    const res = await fetch(`${BACKEND_URL}/loans`, { cache: "no-store" });
    if (!res.ok) throw new Error(`Loans fetch failed: ${res.status}`);
    loanData = await res.json();
  } catch (err) {
    console.warn("Backend loans failed:", err);
    loanData = await loadLoans();  // Fallback to existing GitHub loader
  }
  loans = loanData.loans || [];

  // Load borrowers (backend first, GitHub fallback)
  let borrowerData;
  try {
    const res = await fetch(`${BACKEND_URL}/borrowers`, { cache: "no-store" });
    if (!res.ok) throw new Error(`Borrowers fetch failed: ${res.status}`);
    borrowerData = await res.json();
  } catch (err) {
    console.warn("Backend borrowers failed:", err);
    const fallbackRes = await fetch("https://raw.githubusercontent.com/jeff-stratofied/loan-valuation/main/data/borrowers.json", { cache: "no-store" });
    borrowerData = await fallbackRes.json();
  }
  BORROWERS.length = 0;
  BORROWERS.push(...(borrowerData.borrowers || borrowerData || []));

  // Load valuation curves (backend first, GitHub fallback)
  try {
    await loadValuationCurves(`${BACKEND_URL}/valuationCurves`, { cache: "no-store" });
  } catch (err) {
    console.warn("Backend curves failed:", err);
    await loadValuationCurves("https://raw.githubusercontent.com/jeff-stratofied/loan-valuation/main/data/valuationCurves.json", { cache: "no-store" });
  }

let SCHOOL_TIERS = {};
try {
  const res = await fetch(`${BACKEND_URL}/schoolTiers`, { cache: "no-store" });
  if (res.ok) SCHOOL_TIERS = await res.json();
  else throw new Error("Backend school tiers failed");
} catch (err) {
  console.warn("School tiers backend failed:", err);
  const fallbackRes = await fetch("https://raw.githubusercontent.com/jeff-stratofied/loan-valuation/main/data/schoolTiers.json", { cache: "no-store" });
  SCHOOL_TIERS = await fallbackRes.json();
}

  // NEW: Load school tiers (after curves, before render)
try {
  await loadSchoolTiers(`${BACKEND_URL}/schoolTiers`, { cache: "no-store" });
} catch (err) {
  console.warn("Backend school tiers failed:", err);
  await loadSchoolTiers("https://raw.githubusercontent.com/jeff-stratofied/loan-valuation/main/data/schoolTiers.json", { cache: "no-store" });
}
  
  renderValuations();
}

function renderValuations() {
  if (!VALUATION_CURVES) return; // Guard

  const tbody = document.querySelector('.valuation-table tbody');
  tbody.innerHTML = '';

  let totalPrincipal = 0;
  let totalNPV = 0;
  let totalExpectedLoss = 0;
  let weightedWAL = 0;

  loans.forEach((loan) => {
    const systemBorrower = getBorrowerById(loan.borrowerId) || {}; // Use from borrowerStore.js
    const effectiveBorrower = getEffectiveBorrower({ loan, systemBorrower });
    const valuation = valueLoan({ loan, borrower: effectiveBorrower, riskFreeRate: RISK_FREE_RATE });
    const principal = Number(loan.principal);

    totalPrincipal += principal;
    totalNPV += valuation.npv;
    totalExpectedLoss += valuation.expectedLoss * principal;
    weightedWAL += valuation.wal * principal;

    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${loan.loanName || loan.loanId}</td>
      <td>$${principal.toLocaleString()}</td>
      <td>${(loan.rate * 100).toFixed(2)}%</td>
      <td>${loan.termYears}</td>
      <td>${effectiveBorrower.borrowerFico || '—'}</td>
      <td>${effectiveBorrower.cosignerFico || '—'}</td>
      <td>${deriveFicoBand(Math.max(effectiveBorrower.borrowerFico || 0, effectiveBorrower.cosignerFico || 0))}</td>
      <td>${valuation.riskTier}</td>
      <td>${(valuation.discountRate * 100).toFixed(2)}%</td>
      <td>$${Math.round(valuation.npv).toLocaleString()}</td>
      <td>${(valuation.npvRatio * 100).toFixed(1)}%</td>
      <td>${(valuation.expectedLoss * 100).toFixed(2)}%</td>
      <td>${valuation.wal.toFixed(1)}</td>
    `;
    row.onclick = () => openValuationDrawer({ loan, borrower: effectiveBorrower, valuation });
    tbody.appendChild(row);
  });

  // Portfolio summary
  const summaryRow = document.createElement('tr');
  summaryRow.className = 'summary-row';
  summaryRow.innerHTML = `
    <td><strong>Portfolio Total</strong></td>
    <td>$${totalPrincipal.toLocaleString()}</td>
    <td colspan="5"></td>
    <td></td>
    <td></td>
    <td>$${Math.round(totalNPV).toLocaleString()}</td>
    <td>${((totalNPV / totalPrincipal - 1) * 100).toFixed(1)}%</td>
    <td>${((totalExpectedLoss / totalPrincipal) * 100).toFixed(2)}%</td>
    <td>${(weightedWAL / totalPrincipal).toFixed(1)}</td>
  `;
  tbody.appendChild(summaryRow);
}


function renderValuationDetails(loan, borrower, valuation) {
  // 1. Loan Inputs
  document.getElementById("val-loan-inputs").innerHTML = `
    <div>Principal: $$    {Number(loan.principal).toLocaleString()}</div>
    <div>Rate: ${(loan.rate * 100).toFixed(2)}%</div>
    <div>Term: ${loan.termYears} years</div>
  `;

  // 2. Borrower Profile
  const effectiveFico = Math.max(borrower.borrowerFico || 0, borrower.cosignerFico || 0);
  document.getElementById("val-borrower").innerHTML = `
    <div>Borrower FICO: ${borrower.borrowerFico || "—"}</div>
    <div>Cosigner FICO: ${borrower.cosignerFico || "—"}</div>
    <div>Degree: ${borrower.degreeType || "Other"}</div>
    <div>FICO Band: ${deriveFicoBand(effectiveFico)}</div>
  `;

  // 3. Risk Breakdown
  const tierColorMap = {
    "Low Risk":    "green",
    "Medium Risk": "yellow",
    "High Risk":   "orange",
    "Very High Risk": "red"
  };
  const color = tierColorMap[valuation.riskTier] || "gray";
  document.getElementById("val-risk").innerHTML = `
    <div>Risk Tier: <span class="text-\( {color}-600 font-bold"> \){valuation.riskTier}</span></div>
    <div>Base Risk (bps): ${valuation.riskBreakdown?.baseRiskBps ?? "—"}</div>
    <div>Degree Adj: ${valuation.riskBreakdown?.degreeAdj ?? "—"}</div>
    <div>School Adj: ${valuation.riskBreakdown?.schoolAdj ?? "—"}</div>
    <div>Year Adj: ${valuation.riskBreakdown?.yearAdj ?? "—"}</div>
    <div>Grad Adj: ${valuation.riskBreakdown?.gradAdj ?? "—"}</div>
    <div>Total Risk (bps): ${valuation.riskBreakdown?.totalRiskBps ?? "—"}</div>
  `;

  // 4. Discount Table (already good, but add safe access if needed)
  document.getElementById("val-discount-table").innerHTML = `
    <tr><td>Risk-Free Rate</td><td>${(RISK_FREE_RATE * 100).toFixed(2)}%</td></tr>
    <tr><td>Risk Premium</td><td>${((valuation.discountRate - RISK_FREE_RATE) * 100).toFixed(2)}%</td></tr>
    <tr><td>Total Discount Rate</td><td>${(valuation.discountRate * 100).toFixed(2)}%</td></tr>
  `;

  // 5. Summary
  const npvRatio = loan.principal > 0 ? (valuation.npv / loan.principal) - 1 : null;
  document.getElementById("val-summary").innerHTML = `
    <div>NPV:     $${Math.round(valuation.npv).toLocaleString()}</div>
    <div>NPV / Principal: ${npvRatio == null ? "—" : `${(npvRatio * 100).toFixed(1)}%`}</div>
    <div>Expected Loss %: ${(valuation.expectedLoss * 100).toFixed(2)}%</div>
    <div>WAL (yrs): ${valuation.wal.toFixed(1)}</div>
  `;
}


function rerunValuation(drawer) {
  const systemBorrower = drawer._systemBorrower;

  const borrower = getEffectiveBorrower({
    loan: drawer._loan,
    systemBorrower
  });

  const valuation = valueLoan({
    loan: drawer._loan,
    borrower,
    riskFreeRate: RISK_FREE_RATE
  });

  renderValuationDetails(
    drawer._loan,
    borrower,
    valuation
  );

  // Keep drawer state in sync
  drawer._borrower = borrower;

  // Manually trigger table row re-render to reflect the "Edited" badge
  renderValuations();
}



window.resetValuationOverride = function () {
  const drawer = document.getElementById("valuation-drawer");
  const loanId = drawer._loan.loanId;

  // Remove override from the in-memory map
  VALUATION_OVERRIDES.delete(loanId);

  // Remove override from localStorage
  const overrides = Object.fromEntries(VALUATION_OVERRIDES.entries());
  localStorage.setItem("loanValuationOverrides", JSON.stringify(overrides));

  // Get the system borrower data (i.e., before any overrides)
  const systemBorrower = drawer._systemBorrower;

  // Manually reset form fields with system borrower values
  const ficoSelect = document.getElementById("val-borrower-fico");
  ficoSelect.value = systemBorrower.borrowerFico ?? "";

  const degreeSelect = document.getElementById("val-degree-type");
  degreeSelect.value = systemBorrower.degreeType ?? "Other";

  // Prepare the borrower data for recalculation - COMPLETE WITH ALL FIELDS
  const borrower = {
    borrowerFico: ficoSelect.value ? Number(ficoSelect.value) : systemBorrower.borrowerFico,
    degreeType: degreeSelect.value || systemBorrower.degreeType,
    cosignerFico: systemBorrower.cosignerFico ?? null,
    school: systemBorrower.school ?? "Unknown",
    yearInSchool: systemBorrower.yearInSchool ?? 1,
    isGraduateStudent: systemBorrower.isGraduateStudent ?? false
  };

  // Re-run valuation for the updated loan (to reflect the reset)
  const valuation = valueLoan({
    loan: drawer._loan,
    borrower,
    riskFreeRate: RISK_FREE_RATE
  });

  // Recalculate the discount rate and NPV with updated values
  renderValuationDetails(drawer._loan, borrower, valuation);

  // Refresh the table to reflect the changes (no overrides)
  renderValuations();

  // Re-populate the drawer inputs with system values immediately, passing the recalculated valuation
  // OPTIONAL: Comment out or remove this if you want to avoid redundancy (drawer is already updated and open)
  openValuationDrawer({
    loan: drawer._loan,
    borrower: systemBorrower,
    valuation: valuation // Pass the recalculated valuation object here
  });
};



init();
</script>
</section>


  
</body>
</html>
